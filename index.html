<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Prioritizer - Asisten Tugas Harian</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .task-card { transition: all 0.3s ease; }
        .task-card:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .completed { text-decoration: line-through; opacity: 0.6; }
        .priority-badge { font-size: 0.7rem; font-weight: 600; padding: 2px 8px; border-radius: 9999px; }
        .priority-high { background-color: #FECACA; color: #991B1B; }
        .priority-medium { background-color: #FEF3C7; color: #92400E; }
        .priority-low { background-color: #D1FAE5; color: #065F46; }
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
            z-index: 1000;
        }
        .toast.show { opacity: 1; }
        .toast.success { background-color: #10B981; }
        .toast.error { background-color: #EF4444; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-8">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">Asisten Prioritas Tugas</h1>
            <p class="mt-2 text-slate-600">Fokus pada hal yang paling penting, sekarang juga.</p>
        </header>

        <div id="auth-state" class="mb-6 text-center">
            <p class="text-sm text-slate-500">Memuat data pengguna...</p>
        </div>

        <main id="main-content" class="hidden">
            <!-- Form untuk menambah tugas -->
            <div class="bg-white p-6 rounded-xl shadow-md mb-8">
                <h2 class="text-xl font-semibold mb-4">Tambah Tugas Baru</h2>
                <form id="task-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="md:col-span-2">
                        <label for="task-name" class="block text-sm font-medium text-slate-700 mb-1">Nama Tugas</label>
                        <input type="text" id="task-name" placeholder="Contoh: Mengerjakan Laporan Proyek Akhir" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label for="task-urgency" class="block text-sm font-medium text-slate-700 mb-1">Urgensi (1-5)</label>
                        <input type="range" id="task-urgency" min="1" max="5" value="3" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        <span id="urgency-value" class="text-sm text-slate-500">3 (Sedang)</span>
                    </div>
                    <div>
                        <label for="task-importance" class="block text-sm font-medium text-slate-700 mb-1">Pentingnya (1-5)</label>
                        <input type="range" id="task-importance" min="1" max="5" value="3" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        <span id="importance-value" class="text-sm text-slate-500">3 (Cukup Penting)</span>
                    </div>
                    <div class="md:col-span-2">
                        <label for="task-time" class="block text-sm font-medium text-slate-700 mb-1">Estimasi Waktu (Jam)</label>
                        <input type="number" id="task-time" min="0.5" step="0.5" value="1" required class="w-full px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="w-full bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors">
                            Prioritaskan & Tambah
                        </button>
                    </div>
                </form>
            </div>
            
            <!-- Daftar Tugas -->
            <div>
                <h2 class="text-xl font-semibold mb-4">Daftar Tugas Anda (Diurutkan)</h2>
                <div id="task-list" class="space-y-4">
                    <p id="loading-tasks" class="text-slate-500 text-center">Memuat tugas...</p>
                </div>
            </div>
        </main>
    </div>

    <div id="toast-container" class="toast"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            addDoc, 
            onSnapshot, 
            query, 
            serverTimestamp,
            doc,
            updateDoc,
            deleteDoc
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- KONFIGURASI DAN INISIALISASI ---
        let db, auth, userId, appId;
        
        // Cek variabel global dari environment
        appId = typeof __app_id !== 'undefined' ? __app_id : 'default-task-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (!firebaseConfig) {
            console.error("Konfigurasi Firebase tidak ditemukan.");
            document.getElementById('auth-state').innerHTML = `<p class="text-sm text-red-500">Error: Konfigurasi Firebase tidak ditemukan.</p>`;
        } else {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // --- UI HELPER ---
            const urgencyLabels = { 1: 'Sangat Rendah', 2: 'Rendah', 3: 'Sedang', 4: 'Mendesak', 5: 'Sangat Mendesak' };
            const importanceLabels = { 1: 'Tidak Penting', 2: 'Kurang Penting', 3: 'Cukup Penting', 4: 'Penting', 5: 'Sangat Penting' };
            
            const urgencySlider = document.getElementById('task-urgency');
            const importanceSlider = document.getElementById('task-importance');
            const urgencyValue = document.getElementById('urgency-value');
            const importanceValue = document.getElementById('importance-value');

            urgencySlider.addEventListener('input', () => {
                urgencyValue.textContent = `${urgencySlider.value} (${urgencyLabels[urgencySlider.value]})`;
            });
            importanceSlider.addEventListener('input', () => {
                importanceValue.textContent = `${importanceSlider.value} (${importanceLabels[importanceSlider.value]})`;
            });
            
            const showToast = (message, type = 'success') => {
                const toast = document.getElementById('toast-container');
                toast.textContent = message;
                toast.className = `toast show ${type}`;
                setTimeout(() => {
                    toast.className = 'toast';
                }, 3000);
            };

            // --- LOGIKA PRIORITAS ---
            function calculatePriorityScore(urgency, importance, time) {
                // Formula sederhana yang terinspirasi dari model ML.
                // Bobot lebih tinggi pada Urgensi, lalu Pentingnya. Waktu menjadi faktor pengurang.
                const score = (urgency * 3.5) + (importance * 2.5) - (time * 0.5);
                return parseFloat(score.toFixed(2));
            }
            
            // --- AUTENTIKASI ---
            onAuthStateChanged(auth, async (user) => {
                const authStateDiv = document.getElementById('auth-state');
                if (user) {
                    userId = user.uid;
                    authStateDiv.innerHTML = `<p class="text-sm text-green-600">Terhubung sebagai: <span class="font-mono bg-slate-200 px-1 rounded">${userId}</span></p>`;
                    document.getElementById('main-content').classList.remove('hidden');
                    listenToTasks(); // Mulai mendengarkan data setelah user terautentikasi
                } else {
                     authStateDiv.innerHTML = `<p class="text-sm text-slate-500">Tidak terautentikasi. Mencoba login...</p>`;
                     try {
                         if (initialAuthToken) {
                             await signInWithCustomToken(auth, initialAuthToken);
                         } else {
                             await signInAnonymously(auth);
                         }
                     } catch (error) {
                         console.error("Gagal melakukan autentikasi:", error);
                         authStateDiv.innerHTML = `<p class="text-sm text-red-500">Gagal melakukan autentikasi.</p>`;
                         showToast('Gagal terhubung ke server.', 'error');
                     }
                }
            });

            // --- OPERASI FIRESTORE (CRUD) ---
            
            // CREATE
            document.getElementById('task-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                const taskName = document.getElementById('task-name').value;
                const urgency = parseInt(document.getElementById('task-urgency').value);
                const importance = parseInt(document.getElementById('task-importance').value);
                const time = parseFloat(document.getElementById('task-time').value);

                if (!taskName || !userId) {
                    showToast('Nama tugas tidak boleh kosong.', 'error');
                    return;
                }
                
                const priorityScore = calculatePriorityScore(urgency, importance, time);

                try {
                    const tasksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/tasks`);
                    await addDoc(tasksCollectionRef, {
                        name: taskName,
                        urgency: urgency,
                        importance: importance,
                        time: time,
                        priorityScore: priorityScore,
                        status: 'pending',
                        createdAt: serverTimestamp()
                    });
                    showToast('Tugas berhasil ditambahkan!');
                    e.target.reset(); // Reset form
                    urgencyValue.textContent = '3 (Sedang)';
                    importanceValue.textContent = '3 (Cukup Penting)';
                } catch (error) {
                    console.error("Error menambahkan dokumen:", error);
                    showToast('Gagal menambahkan tugas.', 'error');
                }
            });
            
            // READ (Real-time)
            function listenToTasks() {
                if (!userId) return;
                const tasksCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/tasks`);
                const q = query(tasksCollectionRef);
                
                onSnapshot(q, (querySnapshot) => {
                    const tasks = [];
                    querySnapshot.forEach((doc) => {
                        tasks.push({ id: doc.id, ...doc.data() });
                    });
                    
                    // Urutkan tugas berdasarkan priorityScore (tertinggi ke terendah)
                    // dan status (pending dulu baru completed)
                    tasks.sort((a, b) => {
                        if (a.status === 'pending' && b.status === 'completed') return -1;
                        if (a.status === 'completed' && b.status === 'pending') return 1;
                        return b.priorityScore - a.priorityScore;
                    });
                    
                    renderTasks(tasks);
                }, (error) => {
                    console.error("Gagal mendengarkan perubahan data:", error);
                    showToast('Gagal memuat data tugas.', 'error');
                });
            }

            // UPDATE
            async function toggleTaskStatus(taskId, currentStatus) {
                if (!userId) return;
                const newStatus = currentStatus === 'pending' ? 'completed' : 'pending';
                const taskDocRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, taskId);
                try {
                    await updateDoc(taskDocRef, { status: newStatus });
                    showToast(`Status tugas diubah menjadi ${newStatus}.`);
                } catch (error) {
                    console.error("Error mengubah status tugas:", error);
                    showToast('Gagal mengubah status tugas.', 'error');
                }
            }
            
            // DELETE
            async function deleteTask(taskId) {
                if (!userId) return;
                if (!confirm('Apakah Anda yakin ingin menghapus tugas ini?')) return;
                
                const taskDocRef = doc(db, `artifacts/${appId}/users/${userId}/tasks`, taskId);
                try {
                    await deleteDoc(taskDocRef);
                    showToast('Tugas berhasil dihapus.');
                } catch (error) {
                    console.error("Error menghapus tugas:", error);
                    showToast('Gagal menghapus tugas.', 'error');
                }
            }
            
            window.toggleTaskStatus = toggleTaskStatus;
            window.deleteTask = deleteTask;

            // --- RENDER ---
            function renderTasks(tasks) {
                const taskListDiv = document.getElementById('task-list');
                document.getElementById('loading-tasks').style.display = 'none';

                if (tasks.length === 0) {
                    taskListDiv.innerHTML = `<div class="text-center p-8 bg-white rounded-lg shadow-md">
                        <h3 class="font-semibold text-lg">Hore, tidak ada tugas!</h3>
                        <p class="text-slate-500 mt-1">Tambahkan tugas baru di atas untuk memulai.</p>
                    </div>`;
                    return;
                }

                taskListDiv.innerHTML = tasks.map(task => {
                    const priorityClass = task.priorityScore > 15 ? 'priority-high' : (task.priorityScore > 8 ? 'priority-medium' : 'priority-low');
                    const priorityText = task.priorityScore > 15 ? 'Prioritas Tinggi' : (task.priorityScore > 8 ? 'Prioritas Sedang' : 'Prioritas Rendah');
                    
                    return `
                    <div class="task-card bg-white p-4 rounded-xl shadow-md flex items-start gap-4 ${task.status === 'completed' ? 'opacity-60' : ''}">
                        <input type="checkbox" onchange="toggleTaskStatus('${task.id}', '${task.status}')" 
                               class="mt-1.5 h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 cursor-pointer" 
                               ${task.status === 'completed' ? 'checked' : ''}>
                        <div class="flex-grow">
                            <div class="flex justify-between items-start">
                               <p class="font-semibold text-lg ${task.status === 'completed' ? 'line-through' : ''}">${task.name}</p>
                               <span class="priority-badge ${priorityClass}">${priorityText} (${task.priorityScore})</span>
                            </div>
                            <div class="text-sm text-slate-500 mt-2 flex flex-wrap gap-x-4 gap-y-1">
                                <span>Urgensi: <strong>${task.urgency}</strong></span>
                                <span>Pentingnya: <strong>${task.importance}</strong></span>
                                <span>Waktu: <strong>${task.time} jam</strong></span>
                            </div>
                        </div>
                        <button onclick="deleteTask('${task.id}')" class="text-slate-400 hover:text-red-500 transition-colors p-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                    `;
                }).join('');
            }
        }
    </script>
</body>
</html>

